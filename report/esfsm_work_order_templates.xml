<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Custom minimal layout with proper UTF-8 -->
    <template id="report_work_order_layout">
        <t t-call="web.html_container">
            <t t-raw="'&lt;!DOCTYPE html&gt;'"/>
            <html>
                <head>
                    <meta charset="utf-8"/>
                    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
                    <t t-call-assets="web.report_assets_common" t-js="false"/>
                </head>
                <body class="container">
                    <t t-raw="0"/>
                </body>
            </html>
        </t>
    </template>

    <!-- Main Report Template -->
    <template id="report_work_order_document">
        <t t-call="esfsm_report.report_work_order_layout">
            <t t-foreach="docs" t-as="o">
                <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)"/>
                <div class="page" style="font-size: 10pt; padding: 15px;">
                    <!-- Compact Custom Header -->
                    <table style="width: 100%; border-bottom: 2px solid #3498db; margin-bottom: 15px; padding-bottom: 8px;">
                        <tr>
                            <td style="width: 30%; vertical-align: middle;">
                                <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)"
                                     style="max-height: 50px; max-width: 100%;"/>
                            </td>
                            <td style="width: 70%; text-align: right; vertical-align: middle; font-size: 9pt;">
                                <strong t-field="o.company_id.name" style="font-size: 11pt;"/><br/>
                                <span t-field="o.company_id.street"/><t t-if="o.company_id.street2">, <span t-field="o.company_id.street2"/></t><br/>
                                <span t-field="o.company_id.zip"/> <span t-field="o.company_id.city"/><t t-if="o.company_id.country_id">, <span t-field="o.company_id.country_id.name"/></t><br/>
                                <t t-if="o.company_id.phone">Тел: <span t-field="o.company_id.phone"/></t>
                                <t t-if="o.company_id.email"> | Email: <span t-field="o.company_id.email"/></t>
                            </td>
                        </tr>
                    </table>
                    <!-- Report Title -->
                    <div class="text-center" style="margin-bottom: 12px;">
                        <h2 style="font-size: 16pt; font-weight: bold; color: #2c3e50; margin: 0;">
                            РАБОТЕН НАЛОГ бр. <span t-field="o.name" style="color: #3498db;"/>
                        </h2>
                    </div>

                    <!-- Job Header Information -->
                    <table style="width: 100%; margin-bottom: 10px; font-size: 9pt; border-collapse: collapse;">
                        <tr>
                            <td style="width: 20%; padding: 3px; font-weight: bold; vertical-align: top;" t-if="o.job_type_id">Тип:</td>
                            <td style="width: 30%; padding: 3px; vertical-align: top;" t-if="o.job_type_id">
                                <span t-field="o.job_type_id.name"/>
                            </td>
                            <td style="width: 20%; padding: 3px; font-weight: bold; vertical-align: top;">Датум:</td>
                            <td style="width: 30%; padding: 3px; vertical-align: top;">
                                <span t-field="o.create_date" t-options='{"widget": "date"}'/>
                            </td>
                        </tr>
                        <tr t-if="o.scheduled_date_start">
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px; font-weight: bold; vertical-align: top;">Закажано:</td>
                            <td style="padding: 3px; vertical-align: top;">
                                <span t-field="o.scheduled_date_start" t-options='{"widget": "datetime"}'/>
                            </td>
                        </tr>
                        <tr t-if="o.date_start">
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px; font-weight: bold; vertical-align: top;">Започнато:</td>
                            <td style="padding: 3px; vertical-align: top;">
                                <span t-field="o.date_start" t-options='{"widget": "datetime"}'/>
                            </td>
                        </tr>
                        <tr t-if="o.date_end">
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px;"></td>
                            <td style="padding: 3px; font-weight: bold; vertical-align: top;">Завршено:</td>
                            <td style="padding: 3px; vertical-align: top;">
                                <span t-field="o.date_end" t-options='{"widget": "datetime"}'/>
                            </td>
                        </tr>
                    </table>

                    <!-- Customer and Location Information -->
                    <table style="width: 100%; margin-bottom: 10px; font-size: 9pt; border-collapse: collapse;">
                        <tr>
                            <!-- Customer (Left Column) -->
                            <td style="width: 50%; padding: 8px; vertical-align: top; background-color: #f8f9fa;">
                                <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #3498db; padding-bottom: 2px; font-size: 10pt;">
                                    Клиент
                                </div>
                                <strong><span t-field="o.partner_id.name"/></strong><br/>
                                <span t-if="o.partner_id.phone">
                                    Тел: <span t-field="o.partner_id.phone"/><br/>
                                </span>
                                <span t-if="o.partner_id.email">
                                    Email: <span t-field="o.partner_id.email"/><br/>
                                </span>
                                <span t-if="o.partner_id.street">
                                    <span t-field="o.partner_id"
                                        t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
                                </span>
                            </td>
                            <!-- Location (Right Column) -->
                            <td style="width: 50%; padding: 8px; vertical-align: top; background-color: #fff3e0;">
                                <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #ff9800; padding-bottom: 2px; font-size: 10pt;">
                                    Локација
                                </div>
                                <t t-if="o.site_id">
                                    <strong><span t-field="o.site_id.name"/></strong><br/>
                                    <t t-if="o.site_id.street or o.site_id.city">
                                        <span t-if="o.site_id.street" t-field="o.site_id.street"/>
                                        <t t-if="o.site_id.street2">, <span t-field="o.site_id.street2"/></t><br/>
                                        <span t-if="o.site_id.zip" t-field="o.site_id.zip"/>
                                        <span t-if="o.site_id.city" t-field="o.site_id.city"/>
                                        <t t-if="o.site_id.country_id">, <span t-field="o.site_id.country_id.name"/></t>
                                    </t>
                                    <t t-if="o.site_id.contact_name or o.site_id.contact_phone">
                                        <br/>
                                        <span t-if="o.site_id.contact_name">Контакт: <span t-field="o.site_id.contact_name"/></span>
                                        <span t-if="o.site_id.contact_phone"> | Тел: <span t-field="o.site_id.contact_phone"/></span>
                                    </t>
                                </t>
                                <t t-else="">
                                    <span style="color: #999; font-style: italic;">Не е дефинирана</span>
                                </t>
                            </td>
                        </tr>
                    </table>

                    <!-- Technician/Team Information -->
                    <div class="row" style="margin-bottom: 10px;">
                        <div class="col-12" style="background-color: #e8f5e9; padding: 8px; font-size: 9pt;">
                            <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #4caf50; padding-bottom: 2px; font-size: 10pt;">
                                Техничар / Тим / Возило
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <span t-if="o.employee_ids">
                                        <strong>Техничари:</strong>
                                        <span t-foreach="o.employee_ids" t-as="emp">
                                            <span t-field="emp.name"/><t t-if="not emp_last">, </t>
                                        </span>
                                        <br/>
                                    </span>
                                    <span t-if="o.team_id">
                                        <strong>Тим:</strong> <span t-field="o.team_id.name"/><br/>
                                        <span t-if="o.team_id.member_ids">
                                            <strong>Членови:</strong>
                                            <t t-foreach="o.team_id.member_ids" t-as="member">
                                                <span t-field="member.name"/><t t-if="not member_last">, </t>
                                            </t>
                                            <br/>
                                        </span>
                                    </span>
                                    <span t-if="o.effective_vehicle_ids">
                                        <strong>Возило:</strong>
                                        <t t-foreach="o.effective_vehicle_ids" t-as="vehicle">
                                            <span t-field="vehicle.license_plate"/><t t-if="not vehicle_last">, </t>
                                        </t>
                                    </span>
                                </div>
                                <div class="col-6" t-if="o.scheduled_duration or o.date_start">
                                    <strong>Планирано траење:</strong> <span t-esc="o._get_scheduled_duration_display()"/><br/>
                                    <strong>Вкупно траење:</strong>
                                    <span t-esc="o._get_duration_display()"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Description -->
                    <div t-if="o.description" style="margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 2px; border-bottom: 1px solid #ff9800; padding-bottom: 2px; font-size: 10pt;">
                            Опис на работата
                        </div>
                        <style>
                            .description-content ul, .description-content ol { margin: 2px 0; padding-left: 18px; }
                            .description-content li { margin: 0; padding: 0; line-height: 1.3; }
                            .description-content p { margin: 2px 0; }
                        </style>
                        <div class="description-content" style="background-color: #fff3e0; padding: 4px 6px; font-size: 9pt;">
                            <t t-raw="o.description"/>
                        </div>
                    </div>

                    <!-- Checklist Section -->
                    <div t-if="o.checklist_ids" style="margin-bottom: 10px; page-break-inside: avoid; width: 100%;">
                        <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #9c27b0; padding-bottom: 2px; font-size: 10pt;">
                            Контролна листа
                            <small style="color: #666; font-weight: normal;">
                                (<span t-esc="o.checklist_done_count"/> / <span t-esc="o.checklist_total_count"/> завршено)
                            </small>
                        </div>
                        <table style="font-size: 9pt; margin-bottom: 0; width: 100%; border-collapse: collapse; border: 1px solid #333; table-layout: fixed;">
                            <thead style="background-color: #e1bee7; color: #2c3e50;">
                                <tr>
                                    <th style="width: 4%; padding: 4px; text-align: center; border: 1px solid #333;">#</th>
                                    <th style="width: 6%; padding: 4px; text-align: center; border: 1px solid #333;">✓</th>
                                    <th style="width: 60%; padding: 4px; border: 1px solid #333;">Задача</th>
                                    <th style="width: 30%; padding: 4px; border: 1px solid #333;">Забелешки</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="o.checklist_ids" t-as="item">
                                    <td style="padding: 4px; text-align: center; border: 1px solid #333;"><span t-esc="item_index + 1"/></td>
                                    <td style="padding: 4px; text-align: center; border: 1px solid #333;">
                                        <span t-if="item.done" style="color: green; font-size: 14px;">✓</span>
                                        <span t-else="" style="color: #ccc; font-size: 14px;">☐</span>
                                    </td>
                                    <td style="padding: 4px; border: 1px solid #333;">
                                        <span t-field="item.name"
                                              t-att-style="item.done and 'text-decoration: line-through; color: #888;' or ''"/>
                                    </td>
                                    <td style="padding: 4px; border: 1px solid #333;">
                                        <span t-field="item.notes" style="font-size: 8pt; color: #666;"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Materials Section (always show with min 15 rows for manual entry) -->
                    <div style="margin-bottom: 10px; page-break-inside: avoid;">
                        <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #f44336; padding-bottom: 2px; font-size: 10pt;">
                            Материјали
                        </div>
                        <t t-set="materials_list" t-value="o._get_materials_for_report(10)"/>
                        <table style="font-size: 9pt; margin-bottom: 0; width: 100%; border-collapse: collapse; border: 1px solid #333;">
                            <thead style="background-color: #e8f5e9; color: #2c3e50;">
                                <tr>
                                    <th style="width: 5%; padding: 4px; text-align: center; border: 1px solid #333;">#</th>
                                    <th style="width: 50%; padding: 4px; border: 1px solid #333;">Производ</th>
                                    <th style="width: 13%; text-align: right; padding: 4px; border: 1px solid #333;">Земено</th>
                                    <th style="width: 13%; text-align: right; padding: 4px; border: 1px solid #333;">Искористено</th>
                                    <th style="width: 13%; text-align: right; padding: 4px; border: 1px solid #333;">Вратено</th>
                                    <th style="width: 6%; padding: 4px; text-align: center; border: 1px solid #333;">ЕМ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr t-foreach="materials_list" t-as="material">
                                    <td style="padding: 4px; text-align: center; border: 1px solid #333; height: 22px;"><span t-esc="material_index + 1"/></td>
                                    <td style="padding: 4px; border: 1px solid #333; height: 22px;">
                                        <span t-esc="material.get('product_name', '')"/>
                                    </td>
                                    <td style="padding: 4px; text-align: right; border: 1px solid #333; height: 22px;">
                                        <span t-if="not material.get('is_empty')" t-esc="material.get('taken_qty', '')"/>
                                    </td>
                                    <td style="padding: 4px; text-align: right; border: 1px solid #333; height: 22px;">
                                        <strong t-if="not material.get('is_empty')"><span t-esc="material.get('used_qty', '')"/></strong>
                                    </td>
                                    <td style="padding: 4px; text-align: right; border: 1px solid #333; height: 22px;">
                                        <span t-if="not material.get('is_empty')" t-esc="material.get('returned_qty', '')"/>
                                    </td>
                                    <td style="padding: 4px; text-align: center; border: 1px solid #333; height: 22px;">
                                        <span t-esc="material.get('uom_name', '')"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Timesheet Section (if esfsm_timesheet is installed) -->
                    <t t-if="o._has_timesheet_module() and o.timesheet_ids">
                        <div style="margin-bottom: 10px; page-break-inside: avoid; width: 100%;">
                            <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #009688; padding-bottom: 2px; font-size: 10pt;">
                                Времиња
                            </div>
                            <table style="font-size: 9pt; margin-bottom: 0; width: 100%; border-collapse: collapse; border: 1px solid #333; table-layout: fixed;">
                                <thead style="background-color: #b2dfdb; color: #2c3e50;">
                                    <tr>
                                        <th style="width: 4%; padding: 4px; text-align: center; border: 1px solid #333;">#</th>
                                        <th style="width: 10%; padding: 4px; border: 1px solid #333;">Датум</th>
                                        <th style="width: 16%; padding: 4px; border: 1px solid #333;">Вработен</th>
                                        <th style="width: 58%; padding: 4px; border: 1px solid #333;">Опис</th>
                                        <th style="width: 12%; padding: 4px; text-align: right; border: 1px solid #333;">Часови</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="o.timesheet_ids" t-as="timesheet">
                                        <td style="padding: 4px; text-align: center; border: 1px solid #333;"><span t-esc="timesheet_index + 1"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="timesheet.date"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="timesheet.employee_id.name"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="timesheet.name"/></td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333;">
                                            <span t-field="timesheet.unit_amount" t-options='{"widget": "float_time"}'/>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr style="background-color: #e0f2f1; font-weight: bold;">
                                        <td colspan="4" style="padding: 4px; text-align: right; border: 1px solid #333;">ВКУПНО ЧАСОВИ:</td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333;">
                                            <span t-field="o.total_hours" t-options='{"widget": "float_time"}'/>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </t>

                    <!-- Resolution Notes Section -->
                    <t t-if="o.resolution_notes">
                        <div style="margin-bottom: 10px; page-break-inside: avoid;">
                            <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #673ab7; padding-bottom: 2px; font-size: 10pt;">
                                Завршни забелешки
                            </div>
                            <div style="background-color: #f3e5f5; padding: 6px; font-size: 9pt;">
                                <t t-raw="o.resolution_notes"/>
                            </div>
                        </div>
                    </t>

                    <!-- Visit Log Section (conditional) -->
                    <t t-if="o.include_visit_log_in_print and o.visit_log_ids">
                        <div style="margin-bottom: 10px; page-break-inside: avoid; width: 100%;">
                            <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #607d8b; padding-bottom: 2px; font-size: 10pt;">
                                Дневник на посети
                                <small style="color: #666; font-weight: normal;">
                                    (<span t-esc="len(o.visit_log_ids)"/> записи)
                                </small>
                            </div>
                            <table style="font-size: 9pt; margin-bottom: 0; width: 100%; border-collapse: collapse; border: 1px solid #333; table-layout: fixed;">
                                <thead style="background-color: #cfd8dc; color: #2c3e50;">
                                    <tr>
                                        <th style="width: 4%; padding: 4px; text-align: center; border: 1px solid #333;">#</th>
                                        <th style="width: 18%; padding: 4px; border: 1px solid #333;">Датум/Време</th>
                                        <th style="width: 18%; padding: 4px; border: 1px solid #333;">Корисник</th>
                                        <th style="width: 60%; padding: 4px; border: 1px solid #333;">Забелешка</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="o.visit_log_ids" t-as="log">
                                        <td style="padding: 4px; text-align: center; border: 1px solid #333;"><span t-esc="log_index + 1"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="log.date" t-options='{"widget": "datetime"}'/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="log.user_id.name"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="log.note"/></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </t>

                    <!-- Travel Section -->
                    <t t-if="o.travel_ids">
                        <div style="margin-bottom: 10px; page-break-inside: avoid; width: 100%;">
                            <div style="font-weight: bold; margin-bottom: 4px; border-bottom: 1px solid #795548; padding-bottom: 2px; font-size: 10pt;">
                                Патувања
                                <small style="color: #666; font-weight: normal;">
                                    (Вкупно: <span t-esc="'%.1f' % o.total_travel_time"/> ч, <span t-esc="'%.0f' % sum(o.travel_ids.mapped('distance'))"/> км)
                                </small>
                            </div>
                            <table style="font-size: 9pt; margin-bottom: 0; width: 100%; border-collapse: collapse; border: 1px solid #333; table-layout: fixed;">
                                <thead style="background-color: #d7ccc8; color: #2c3e50;">
                                    <tr>
                                        <th style="width: 4%; padding: 4px; text-align: center; border: 1px solid #333;">#</th>
                                        <th style="width: 12%; padding: 4px; border: 1px solid #333;">Датум</th>
                                        <th style="width: 20%; padding: 4px; border: 1px solid #333;">Возило</th>
                                        <th style="width: 18%; padding: 4px; border: 1px solid #333;">Возач</th>
                                        <th style="width: 12%; padding: 4px; text-align: right; border: 1px solid #333;">Почеток км</th>
                                        <th style="width: 12%; padding: 4px; text-align: right; border: 1px solid #333;">Крај км</th>
                                        <th style="width: 10%; padding: 4px; text-align: right; border: 1px solid #333;">Км</th>
                                        <th style="width: 12%; padding: 4px; text-align: right; border: 1px solid #333;">Време</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="o.travel_ids" t-as="travel">
                                        <td style="padding: 4px; text-align: center; border: 1px solid #333;"><span t-esc="travel_index + 1"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="travel.date"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="travel.vehicle_id.license_plate"/></td>
                                        <td style="padding: 4px; border: 1px solid #333;"><span t-field="travel.driver_id.name"/></td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333;">
                                            <span t-esc="'%.0f' % travel.odometer_start" t-if="travel.odometer_start"/>
                                        </td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333;">
                                            <span t-esc="'%.0f' % travel.odometer_end" t-if="travel.odometer_end"/>
                                        </td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333; font-weight: bold;">
                                            <span t-esc="'%.0f' % travel.distance"/>
                                        </td>
                                        <td style="padding: 4px; text-align: right; border: 1px solid #333;">
                                            <span t-field="travel.travel_time" t-options='{"widget": "float_time"}'/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </t>

                    <!-- Signatures Section -->
                    <table style="width: 100%; margin-top: 20px; page-break-inside: avoid; font-size: 9pt;">
                        <tr>
                            <td style="width: 50%; padding-right: 5px; vertical-align: top;">
                                <div style="border: 1px solid #ddd; padding: 8px; min-height: 60px;">
                                    <div style="font-weight: bold; margin-bottom: 6px; font-size: 10pt;">
                                        Потпис на техничар
                                    </div>
                                    <div style="min-height: 30px; margin-bottom: 6px; text-align: center;">
                                        <img t-if="o.technician_signature"
                                             t-att-src="'data:image/png;base64,%s' % o.technician_signature.decode('utf-8')"
                                             style="max-height: 30px; max-width: 100%;"/>
                                    </div>
                                    <div style="border-top: 1px solid #999; padding-top: 3px; text-align: center;">
                                        <div style="margin-bottom: 2px; font-size: 8pt; color: #666;">
                                            Име, презиме, потпис
                                        </div>
                                        <span t-if="o.technician_signature_date">
                                            Датум: <span t-field="o.technician_signature_date" t-options='{"widget": "date"}'/>
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td style="width: 50%; padding-left: 5px; vertical-align: top;">
                                <div style="border: 1px solid #ddd; padding: 8px; min-height: 60px;">
                                    <div style="font-weight: bold; margin-bottom: 6px; font-size: 10pt;">
                                        Потпис на клиент
                                    </div>
                                    <div style="min-height: 30px; margin-bottom: 6px; text-align: center;">
                                        <img t-if="o.customer_signature"
                                             t-att-src="'data:image/png;base64,%s' % o.customer_signature.decode('utf-8')"
                                             style="max-height: 30px; max-width: 100%;"/>
                                    </div>
                                    <div style="border-top: 1px solid #999; padding-top: 3px; text-align: center;">
                                        <div style="margin-bottom: 2px; font-size: 8pt; color: #666;">
                                            Име, презиме, потпис
                                        </div>
                                        <span t-if="o.customer_signature_date">
                                            Датум: <span t-field="o.customer_signature_date" t-options='{"widget": "date"}'/>
                                        </span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>

                </div>
            </t>
        </t>
    </template>
</odoo>
